<!doctype html><style>html{height:100vh}body{min-height:100vh;display:grid;grid-template-rows:1fr auto}.footer{grid-row-start:2;grid-row-end:3}</style><html lang=en-us><head><meta charset=utf-8><title>sebescudie</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description property="og:description" content="Writeup du quatrième lab MEMLABS"><meta name=image property="og:image" content="/"><meta name=author content="seb escudie"><meta name=generator content="Hugo 0.83.1"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/uikit@3.2.6/dist/css/uikit.min.css><link rel=stylesheet href=/css/style.min.css integrity media=screen><link rel=stylesheet href=/css/syntax.min.css integrity media=screen><script src=https://cdn.jsdelivr.net/npm/mailgo@0.9.14/dist/mailgo.min.js defer></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body class=blog><div class=wrapper><div uk-sticky="sel-target: .uk-navbar-container; cls-active: uk-navbar-sticky; bottom: #transparent-sticky-navbar"><nav class="uk-navbar-container uk-margin" uk-navbar="mode: click;" style=padding-right:3rem><div class=uk-navbar-right><ul class="uk-navbar-nav uk-visible@s"><li><a style=font-size:18px;text-transform:none href=/>home</a></li><li><a style=font-size:18px;text-transform:none href=/about>about</a></li><li class=uk-active><a style=font-size:18px;text-transform:none href=/blog>blog</a></li><li><a style=font-size:18px;text-transform:none href=/contact>contact</a></li><li><a style=font-size:18px;text-transform:none href=/portfolio>portfolio</a></li></ul><a class="uk-navbar-toggle uk-hidden@s" uk-toggle="target: #sidenav" uk-navbar-toggle-icon href=#></a></div></nav></div><div id=sidenav uk-offcanvas="overlay: true"><div class="uk-offcanvas-bar uk-flex uk-flex-column"><ul class="uk-nav uk-nav-primary uk-nav-center uk-margin-auto-vertical"><li><a style=font-size:18px href>home</a></li><li><a style=font-size:18px href=/about>about</a></li><li class=uk-active><a style=font-size:18px href=/blog>blog</a></li><li><a style=font-size:18px href=/contact>contact</a></li><li><a style=font-size:18px href=/portfolio>portfolio</a></li></ul></div></div><style>p{margin:0}.people-wrap{display:inline-flex;margin-top:10px}.people-image{display:block;border-radius:50%}.people{margin-left:20px;margin-right:20px}.name{margin:auto}h1,h2,h3,h4,h5,h6{color:#000;font-family:Roboto,sans-serif;line-height:1.2;margin-top:2rem}.content img{box-shadow:0 4px 8px rgba(0,0,0,.2),0 6px 20px rgba(0,0,0,.19);display:block;margin-left:auto;margin-right:auto;margin-bottom:30px}.content video{box-shadow:0 4px 8px rgba(0,0,0,.2),0 6px 20px rgba(0,0,0,.19);display:block;margin:0 auto;max-width:60vw;max-height:60vh;margin-bottom:30px}iframe{display:block;margin-left:auto;margin-right:auto;margin-bottom:30px}p{margin-bottom:1em}body p:last-child{margin-bottom:0}img.skills{height:80px}@media only screen and (min-width:960px){.content img{max-width:60vw;max-height:60vh}.content img{max-width:60vw;max-height:60vh}}.content{width:90vw;max-width:1200px}table{font-family:arial,sans-serif;border-collapse:collapse;width:100%}td,th{border:1px solid #ddd;text-align:left;padding:8px}</style><section><div class="uk-container uk-margin-large-bottom uk-margin-medium-top"><h1 class="uk-text-center uk-heading-medium">MEMLABS - LAB04</h1><p class="uk-text-center uk-text-lead">Writeup du quatrième lab MEMLABS</p><hr class=full-width><div class=content><p>Encore un writeup, encore MEMLABS, pour le quatrième challenge cette fois-ci. Commençons par l&rsquo;intro :</p><blockquote><p>My system was recently compromised. The Hacker stole a lot of information but he also deleted a very important file of mine. I have no idea on how to recover it. The only evidence we have, at this point of time is this memory dump. Please help me.</p></blockquote><p>Ok, donc il va sûrement falloir rechercher un fichier supprimé. C&rsquo;est parti !</p><p>Histoire de se simplifier la vie, on va sauvegarder le résultat de <code>pslist</code> dans un fichier texte pour pouvoir s&rsquo;y référer plus facilement. Voilà ce que j&rsquo;ai noté d&rsquo;intéressant :</p><p>StikyNot.exe 2432
GoogleCrashHan 2272
GoogleCrashHan 2284</p><p>Visiblement, on a le widget Sticky Notes d&rsquo;ouvert. J&rsquo;ai déjà vu dans un autre CTF des informations intéressantes (&ndash;> des mots de passe) notés là-dedans. Le contenu des notes est stocké quelque part sur l&rsquo;ordi, on ira donc voir ce qui s&rsquo;y cache !
Aussi, deux process GoogleCrashHandler. Est-ce qu&rsquo;un Chrome aurait planté ? On va regarder ça aussi.</p><h1 id=sticky-notes>Sticky notes</h1><p>Selon <a href=https://www.pcworld.com/article/2090765/where-sticky-notes-are-stored-and-how-you-can-recover-them.html>cet article</a> de PCWorld, &ldquo;Windows stores your sticky notes in a special appdata folder, which is probably C:\Users\logon\AppData\Roaming\Microsoft\Sticky Notes—with logon being the name with which you log onto your PC. You’ll find only one file in that folder, StickyNotes.snt, which contains all your notes&rdquo;. Ok, essayons de chercher ce fichier :</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>┌──<span style=color:#f92672>(</span>kali㉿kali<span style=color:#f92672>)</span>-<span style=color:#f92672>[</span>~/Documents/ctf/MEMLABS<span style=color:#f92672>]</span>
└─$ python ~/volatility/volatility-2.6.1/vol.py -f MemoryDump_Lab4.raw --profile<span style=color:#f92672>=</span>Win7SP1x64 filescan | grep <span style=color:#e6db74>&#34;StickyNotes.snt&#34;</span>
Volatility Foundation Volatility Framework 2.6.1
0x000000003fd40910     <span style=color:#ae81ff>17</span>      <span style=color:#ae81ff>1</span> RW-r-- <span style=color:#ae81ff>\D</span>evice<span style=color:#ae81ff>\H</span>arddiskVolume2<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\S</span>limShady<span style=color:#ae81ff>\A</span>ppData<span style=color:#ae81ff>\R</span>oaming<span style=color:#ae81ff>\M</span>icrosoft<span style=color:#ae81ff>\S</span>ticky Notes<span style=color:#ae81ff>\S</span>tickyNotes.snt
</code></pre></div><p>Cool, maintenant, comment va-t-on faire pour en extraire le contenu ? Après une petite recherche, je tombe sur <a href=https://superuser.com/a/518786>ce post SuperUser</a>, qui semble indiquer qu&rsquo;il s&rsquo;agit en fait d&rsquo;une archive que l&rsquo;on peut ouvrir avec 7Zip. Et effectivement, après un <code>7z x StickyNotes.snt</code>, on obtient bien trois fichiers, dont le premier est un RTF avec le texte suivant :</p><pre><code>The clipboard plugin works well but it doesn't give the flag :P
</code></pre><p>Ok, ça troll. Essayons le plugin clipboard, par curiosité ?</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>┌──<span style=color:#f92672>(</span>kali㉿kali<span style=color:#f92672>)</span>-<span style=color:#f92672>[</span>~/Documents/ctf/MEMLABS<span style=color:#f92672>]</span>
└─$ python ~/volatility/volatility-2.6.1/vol.py -f MemoryDump_Lab4.raw --profile<span style=color:#f92672>=</span>Win7SP1x64 clipboard                           
Volatility Foundation Volatility Framework 2.6.1
Session    WindowStation Format                         Handle Object             Data                                              
---------- ------------- ------------------ ------------------ ------------------ --------------------------------------------------
         <span style=color:#ae81ff>2</span> WinSta0       CF_UNICODETEXT                    0x0 ------------------                                                   
         <span style=color:#ae81ff>2</span> WinSta0       0x0L                             0x10 ------------------                                                   
         <span style=color:#ae81ff>2</span> WinSta0       0x100ffL               0x200000000000 ------------------                                                   
         <span style=color:#ae81ff>2</span> WinSta0       CF_TEXT                           0x1 ------------------                                                   
         <span style=color:#ae81ff>1</span> WinSta0       CF_UNICODETEXT                    0x0 ------------------                                                   
         <span style=color:#ae81ff>1</span> WinSta0       0x0L                             0x10 ------------------                                                   
         <span style=color:#ae81ff>1</span> WinSta0       0x1010bL               0x200000000000 ------------------                                                   
         <span style=color:#ae81ff>1</span> WinSta0       CF_TEXT                           0x1 ------------------                                                   
         <span style=color:#ae81ff>1</span> ------------- ------------------            0x1010b 0xfffff900c1eb75c0                                                   
         <span style=color:#ae81ff>2</span> ------------- ------------------            0x100ff 0xfffff900c1acd390 
</code></pre></div><p>Ok, je ne vois pas trop quoi faire de ces informations pour l&rsquo;instant. En lisant <a href=https://github.com/volatilityfoundation/volatility/wiki/Command-Reference-Gui#clipboard>la doc de clipboard sur le repo de Volatility</a>, j&rsquo;ai vu qu&rsquo;ils mentionnaient le fait qu&rsquo;on pouvait voir le path d&rsquo;un fichier qui aurait été copié-collé avec la commande clipboard. Dans leur exemple, on peut voir qu&rsquo;un fichier a été copié sur le bureau, ça ma donné l&rsquo;idée de regarder si on ne trouvait pas quelque chose d&rsquo;intéressant ici :</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>┌──<span style=color:#f92672>(</span>kali㉿kali<span style=color:#f92672>)</span>-<span style=color:#f92672>[</span>~/Documents/ctf/MEMLABS<span style=color:#f92672>]</span>
└─$ python ~/volatility/volatility-2.6.1/vol.py -f MemoryDump_Lab4.raw --profile<span style=color:#f92672>=</span>Win7SP1x64 filescan | grep <span style=color:#e6db74>&#34;Desktop&#34;</span>            
Volatility Foundation Volatility Framework 2.6.1
0x000000003e8ad250     <span style=color:#ae81ff>14</span>      <span style=color:#ae81ff>0</span> R--r-- <span style=color:#ae81ff>\D</span>evice<span style=color:#ae81ff>\H</span>arddiskVolume2<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\e</span>minem<span style=color:#ae81ff>\D</span>esktop<span style=color:#ae81ff>\g</span>alf.jpeg
0x000000003e8d19e0     <span style=color:#ae81ff>16</span>      <span style=color:#ae81ff>0</span> R--r-- <span style=color:#ae81ff>\D</span>evice<span style=color:#ae81ff>\H</span>arddiskVolume2<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\e</span>minem<span style=color:#ae81ff>\D</span>esktop<span style=color:#ae81ff>\S</span>creenshot1.png
0x000000003fc398d0     <span style=color:#ae81ff>16</span>      <span style=color:#ae81ff>0</span> R--rw- <span style=color:#ae81ff>\D</span>evice<span style=color:#ae81ff>\H</span>arddiskVolume2<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\S</span>limShady<span style=color:#ae81ff>\D</span>esktop<span style=color:#ae81ff>\I</span>mportant.txt
</code></pre></div><p>En effet, y&rsquo;a du monde (j&rsquo;ai supprimé les lignes qui n&rsquo;étaient pas intéressantes, genre <code>Desktop.ini</code>) ! Note pour plus tard : toujours regarder ce qui se trouve sur le bureau dans un CTF :)</p><p>J&rsquo;ai bien réussi à dumper les deux images (<code>galf.jpeg</code> et <code>Screenshot1.png</code>). En revanche, rien ne se passe lorsque j&rsquo;essaye de dumper <code>Important.txt</code>. Après une petite recherche, j&rsquo;apprends dans <a href=https://github.com/volatilityfoundation/volatility/issues/588>cette issue</a> que &ldquo;its possible the file&rsquo;s content isn&rsquo;t cached anymore by the cache manager (its likely to get removed after the process closes the file handle). That doesn&rsquo;t mean the file&rsquo;s content is entirely wiped out of RAM however&mldr;it could just mean the association between the file object and the file data is broken (i.e. pointers).&rdquo;. Peut-être qu&rsquo;il s&rsquo;agit de notre fichier supprimé ? Gardons ça sous le coude pour plus tard.</p><p>Je commence par faire un <code>steghide</code> sur l&rsquo;image <code>galf.jpeg</code>, et à nouveau, ça troll : on obtient un fichier <code>LMAO.txt</code> avec le contenu suivant : <code>Move on bro, there is nothing here :)</code>. SUPER. L&rsquo;autre fichier, <code>Screenshot1.png</code>, est juste un screenshot de Google. Rien ne semble caché dedans, steganographiquement parlant.</p><p>J&rsquo;ai par la suite essayé les plugins permettant d&rsquo;extraire des artefacts de Chrome, mais sans succès.</p><h1 id=fichier-supprimé---le-flag>Fichier supprimé - Le flag</h1><p>Bon, au final on diverge beaucoup mais on trouve pas grand chose. Je décide donc de faire un tour sur internet pour chercher comment recover un fichier supprimé via volatility. Et là, je tombe sur un writeup d&rsquo;un autre CTF créé par stuxn3t, où il est également question de recover un fichier nommé <code>Important.txt</code>. Et là, la réponse tombe toute cuite, il suffit d&rsquo;utiliser le plugin <code>mftparser</code> pour récupérer la Master File Table et avoir accès au fichier, a condition qu&rsquo;il n&rsquo;ait pas été override.</p><p>Et là, sans surprise, si on envoie le résultat de la commande dans in fichier texte, on obtient :</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>MFT entry found at offset 0x3bd8ac00
Attribute: In Use &amp; File
Record Number: <span style=color:#ae81ff>60583</span>
Link count: <span style=color:#ae81ff>2</span>


$STANDARD_INFORMATION
Creation                       Modified                       MFT Altered                    Access Date                    Type
------------------------------ ------------------------------ ------------------------------ ------------------------------ ----
2019-06-27 13:14:13 UTC+0000 2019-06-27 13:26:12 UTC+0000   2019-06-27 13:26:12 UTC+0000   2019-06-27 13:14:13 UTC+0000   Archive

$FILE_NAME
Creation                       Modified                       MFT Altered                    Access Date                    Name/Path
------------------------------ ------------------------------ ------------------------------ ------------------------------ ---------
2019-06-27 13:14:13 UTC+0000 2019-06-27 13:14:13 UTC+0000   2019-06-27 13:14:13 UTC+0000   2019-06-27 13:14:13 UTC+0000   Users<span style=color:#ae81ff>\S</span>limShady<span style=color:#ae81ff>\D</span>esktop<span style=color:#ae81ff>\I</span>MPORT~1.TXT

$FILE_NAME
Creation                       Modified                       MFT Altered                    Access Date                    Name/Path
------------------------------ ------------------------------ ------------------------------ ------------------------------ ---------
2019-06-27 13:14:13 UTC+0000 2019-06-27 13:14:13 UTC+0000   2019-06-27 13:14:13 UTC+0000   2019-06-27 13:14:13 UTC+0000   Users<span style=color:#ae81ff>\S</span>limShady<span style=color:#ae81ff>\D</span>esktop<span style=color:#ae81ff>\I</span>mportant.txt

$OBJECT_ID
Object ID: 7726a550-d498-e911-9cc1-0800275e72bc
Birth Volume ID: 80000000-b800-0000-0000-180000000100
Birth Object ID: 99000000-1800-0000-690d-0a0d0a0d0a6e
Birth Domain ID: 0d0a0d0a-0d0a-6374-0d0a-0d0a0d0a0d0a

$DATA
0000000000: <span style=color:#ae81ff>69</span> 0d 0a 0d 0a 0d 0a 6e 0d 0a 0d 0a 0d 0a <span style=color:#ae81ff>63</span> <span style=color:#ae81ff>74</span>   i......n......ct
0000000010: 0d 0a 0d 0a 0d 0a 0d 0a <span style=color:#ae81ff>66</span> 7b <span style=color:#ae81ff>31</span> 0d 0a 0d 0a 0d   ........f<span style=color:#f92672>{</span>1.....
0000000020: 0a 5f <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>73</span> 0d 0a 0d 0a 0d 0a 5f 6e <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>74</span> 0d 0a   ._is......_n0t..
0000000030: 0d 0a 0d 0a 0d 0a 5f <span style=color:#ae81ff>45</span> <span style=color:#ae81ff>51</span> <span style=color:#ae81ff>75</span> <span style=color:#ae81ff>34</span> 6c 0d 0a 0d 0a   ......_EQu4l....
0000000040: 0d 0a 0d 0a 5f <span style=color:#ae81ff>37</span> 6f 5f <span style=color:#ae81ff>32</span> 5f <span style=color:#ae81ff>62</span> <span style=color:#ae81ff>55</span> <span style=color:#ae81ff>74</span> 0d 0a 0d   ...._7o_2_bUt...
0000000050: 0a 0d 0a 0d 0a 0d 0a 0d 0a 0d 0a 5f <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>31</span> <span style=color:#ae81ff>73</span>   ..........._th1s
0000000060: 5f <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>33</span> 6e <span style=color:#ae81ff>74</span> 0d 0a 0d 0a 0d 0a 0d 0a 5f   _d0s3nt........_
0000000070: 6d <span style=color:#ae81ff>34</span> 6b <span style=color:#ae81ff>65</span> 0d 0a 0d 0a 0d 0a 5f <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>33</span> 6e 0d 0a   m4ke......_s3n..
0000000080: 0d 0a 0d 0a 0d 0a <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>33</span> 7d 0d 0a 0d 0a <span style=color:#ae81ff>47</span> 6f 6f   ......s3<span style=color:#f92672>}</span>....Goo
0000000090: <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>77</span> 6f <span style=color:#ae81ff>72</span> 6b <span style=color:#ae81ff>20</span> 3a <span style=color:#ae81ff>50</span>                        d.work.:P
</code></pre></div><p>Le contenu de <code>$DATA</code> semble bien être un flag : <code>ctf{1_is_n0t_EQu4l_7o_2_bUt_th1s_d0s3nt_m4ke_s3ns3}</code>, suivi d&rsquo;un <code>Good work :P</code>.</p><p>Alors bon, je n&rsquo;avais pas connaissance de ce plugin-là, ni-même de la MFT en soi, on va donc faire de petites recherches sur le sujet histoire de ramener quelque chose de ce CTF :)</p><h1 id=was-ist-das>Was ist das</h1><p>On commence donc par lire <a href=https://docs.microsoft.com/en-us/windows/win32/fileio/master-file-table>la doc Microsoft sur la MFT</a>. Elle nous dit que</p><blockquote><p>[all] information about a file, including its size, time and date stamps, permissions, and data content, is stored either in MFT entries, or in space outside the MFT that is described by MFT entries.
As files are added to an NTFS file system volume, more entries are added to the MFT and the MFT increases in size. When files are deleted from an NTFS file system volume, their MFT entries are marked as free and may be reused. However, disk space that has been allocated for these entries is not reallocated, and the size of the MFT does not decrease</p></blockquote><p>Ok, donc pour chaque fichier sur notre machine, on aurait une entrée dans la MFT qui nous donnerait sa taille, ses dates de création/modification, etc. Selon <a href=https://fr.wikipedia.org/wiki/Master_File_Table>l&rsquo;article Wikipedia</a>, si un fichier est de petite taille (700 à 800 octets visiblement), le fichier est sotcké directement dans la MFT.</p><p>Aussi, je suis tombé sur <a href=https://www.reddit.com/r/computerforensics/comments/jook6y/when_does_an_mft_record_get_deleted/>un fil Reddit plutôt intéressant</a> qui parle de ce qu&rsquo;il se passe lorsque l&rsquo;on supprime un fichier, et comment les entrées de la MFT sont modifiées en fonction.</p><h1 id=conclusion>Conclusion</h1><p>J&rsquo;aurais peut-être pu chercher à recover le fichier supprimé dès le début, mais le fait de tâtonner m&rsquo;a donné l&rsquo;occasion de me pencher sur les Sticky Notes qui peuvent être un artefact intéressant, et aussi de me souvenir de toujours faire un tour sur le Bureau pour trouver des choses intéressantes ! Aussi, j&rsquo;ai pu apprendre les bases du fonctionnement de la MFT, et tester <code>mftparser</code> qui pourra je pense s&rsquo;avérer vachement pratique dans de futurs CTF !</p></div><div class=uk-padding-small></div><section><div class=content></div><div class=content></div></section></div></div></section></div><footer class=footer><div class=uk-container><div class="uk-grid-small uk-child-width-1-4@m uk-text-center uk-flex-center uk-margin-medium-bottom" uk-grid><div class=uk-margin-small-bottom><h5 class=uk-margin-small-bottom>Email</h5><a href=mailto:ping%20%7bat%7d%20sebescudie.fr>ping {at} sebescudie.fr</a></div><div><h5 class=uk-margin-small-bottom>Address</h5><div uk-lightbox><a href="https://www.openstreetmap.org/#map=15/48.8283/2.3695" data-caption="paris, fr" data-type=iframe>paris, fr</a></div></div></div><div class="footer-copyright uk-text-center" style=padding-bottom:1rem><img loading=lazy src=https://mirrors.creativecommons.org/presskit/icons/cc.svg style=height:1.2em;width:1.2em alt="Creative Commons">
<img loading=lazy src=https://mirrors.creativecommons.org/presskit/icons/by.svg style=height:1.2em;width:1.2em alt=CC-BY>
2020
seb escudie</div></footer><script src=https://cdn.jsdelivr.net/npm/uikit@3.2.6/dist/js/uikit.min.js></script><script src=https://cdn.jsdelivr.net/npm/uikit@3.2.6/dist/js/uikit-icons.min.js></script></body></html>